name: Run JMeter Performance Tests

on:
  repository_dispatch:
    types: [run-jmeter-tests]

  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL base de la API a probar'
        required: true
        default: 'https://endpoints-fast-api.onrender.com'
        type: string
      test_plan:
        description: 'Ruta de Test plan a ejecutar'
        required: false
        default: 'test-plans/jmeter/tp-carga-controlada.jmx'
        type: string

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'
  JMETER_VERSION: '5.6.3'

jobs:
  run-performance-tests:
    name: Ejecutar Pruebas de Performance con Docker
    runs-on: ubuntu-latest
    
    steps:
      # ============================================================
      # 1. CHECKOUT
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # ============================================================
      # 2. DOCKER BUILDX
      - name: ğŸ³ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # ============================================================
      # 3. CONFIG VARIABLES
      - name: âš™ï¸ Configurar variables de entorno
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BASE_URL="${{ inputs.base_url }}"
            TEST_PLAN="${{ inputs.test_plan }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BASE_URL="${{ github.event.client_payload.base_url || 'https://endpoints-fast-api.onrender.com' }}"
            TEST_PLAN="${{ github.event.client_payload.test_plan || 'test-plans/jmeter/tp-carga-controlada.jmx' }}"
          else
            BASE_URL="https://endpoints-fast-api.onrender.com"
            TEST_PLAN="test-plans/jmeter/tp-carga-controlada.jmx"
          fi
          
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          echo "test_plan=$TEST_PLAN" >> $GITHUB_OUTPUT
          
          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV
          echo "TEST_PLAN=$TEST_PLAN" >> $GITHUB_ENV
      
      # ============================================================
      # 4. VALIDAR URL
      - name: ğŸ” Validar formato de URL
        run: |
          URL="${{ steps.config.outputs.base_url }}"
          echo "URL recibida: $URL"
          
          if [[ "$URL" == *"__"* ]] || [[ "$URL" == *"**"* ]] || [[ "$URL" == *" "* ]]; then
            echo "âŒ ERROR: La URL contiene caracteres invÃ¡lidos: '$URL'"
            exit 1
          fi
          
          if [[ "$URL" != http://* ]] && [[ "$URL" != https://* ]]; then
            echo "âŒ ERROR: La URL no tiene un esquema vÃ¡lido (http/https): '$URL'"
            exit 1
          fi
          
          echo "âœ… URL vÃ¡lida: $URL"

      # ============================================================
      # 5. SHOW CONFIG
      - name: ğŸ“‹ Mostrar configuraciÃ³n
        run: |
          echo "================================================"
          echo "Base URL:    ${{ steps.config.outputs.base_url }}"
          echo "Test Plan:   ${{ steps.config.outputs.test_plan }}"
          echo "JMeter:      ${JMETER_VERSION}"
          echo "================================================"
      
      # ============================================================
      # 6. CACHE DOCKER
      - name: ğŸ’¾ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      # ============================================================
      # 7. BUILD IMAGE
      - name: ğŸ”¨ Build imagen Docker
        run: |
          echo "ğŸ”¨ Construyendo imagen Docker..."
          docker build \
            --build-arg JMETER_VERSION=${JMETER_VERSION} \
            -t jmeter-runner:latest \
            -f Dockerfile \
            .
          echo "âœ… Imagen construida exitosamente"

      # ============================================================
      # 8. VALIDAR API
      - name: ğŸ” Validar disponibilidad API
        if: ${{ !contains(steps.config.outputs.base_url, 'localhost') }}
        run: |
          echo "ğŸ” Verificando disponibilidad de la API..."
          
          MAX_RETRIES=12
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -sf "${{ steps.config.outputs.base_url }}/api/v1/health" > /dev/null 2>&1; then
              echo "âœ… API disponible"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Intento $RETRY_COUNT/$MAX_RETRIES - esperando..."
            sleep 10
          done
          
          echo "âš ï¸ API no respondiÃ³ al health check, continuando..."
      
      # ============================================================
      # 9. LIMPIAR DOCS (FIX: elimina TODO antes de correr Docker)
      - name: ğŸ§¹ Limpiar docs previo
        run: |
          echo "ğŸ§¹ Limpiando directorio docs/..."
          rm -rf docs/
          mkdir -p docs/
          chmod 777 docs/
          echo "âœ… docs/ limpio"

      # ============================================================
      # 10. CREATE DIRS
      - name: ğŸ“‚ Crear directorios
        run: |
          mkdir -p results
          chmod -R 777 results
      
      # ============================================================
      # 11. RUN TESTS
      - name: ğŸš€ Ejecutar pruebas
        run: |
          echo "ğŸ³ Ejecutando contenedor Docker..."
          docker run --rm \
            -v $(pwd)/results:/tests/results \
            -v $(pwd)/docs:/tests/docs \
            -v $(pwd)/test-plans:/tests/test-plans:ro \
            -v $(pwd)/data:/tests/data:ro \
            -e BASE_URL="${{ steps.config.outputs.base_url }}" \
            -e TEST_PLAN="${{ steps.config.outputs.test_plan }}" \
            jmeter-runner:latest \
            python3 scripts/execute-tests.py \
              --base-url="${{ steps.config.outputs.base_url }}" \
              --test-plan="${{ steps.config.outputs.test_plan }}"
          echo "âœ… Contenedor finalizado"

      # ============================================================
      # 12. VERIFY RESULTS
      - name: ğŸ” Verificar resultados
        run: |
          echo "ğŸ“‚ Verificando estructura de archivos generados..."
          ls -lah results || exit 1
          ls -lah docs || exit 1
      
      # ============================================================
      # 13. UPLOAD ARTIFACTS
      # upload-artifact@v4 ya genera el .zip automÃ¡ticamente.
      # NO empaquetar manualmente: subirlo directo evita el ZIP dentro de ZIP.
      - name: ğŸ“Š Publicar reporte HTML
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ github.run_number }}
          path: docs/
          retention-days: 30

      - name: ğŸ“ Publicar resultados CSV y logs
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results-${{ github.run_number }}
          path: results/run_*/
          retention-days: 30
      
      # ============================================================
      # 14. COMMIT REPORT
      - name: ğŸ’¾ Commit report to repository
        if: success()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add docs/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update JMeter report - run ${{ github.run_number }}"
            git push
          fi
      
      # ============================================================
      # 15. CLEANUP
      - name: ğŸ§¹ Limpiar Docker
        if: always()
        run: docker system prune -f