name: Run JMeter Performance Tests

on:
  repository_dispatch:
    types: [run-jmeter-tests]

  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL base de la API a probar'
        required: true
        default: 'https://endpoints-fast-api.onrender.com'
        type: string
      test_plan:
        description: 'Ruta de Test plan a ejecutar'
        required: false
        default: 'test-plans/jmeter/tp-carga-controlada.jmx'
        type: string

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'
  JMETER_VERSION: '5.6.3'

jobs:
  run-performance-tests:
    name: Ejecutar Pruebas de Performance con Docker
    runs-on: ubuntu-latest
    
    steps:
      # ============================================================
      # 1. CHECKOUT
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      # ============================================================
      # 2. DOCKER BUILDX
      - name: üê≥ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # ============================================================
      # 3. CONFIG VARIABLES
      - name: ‚öôÔ∏è Configurar variables de entorno
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BASE_URL="${{ inputs.base_url }}"
            TEST_PLAN="${{ inputs.test_plan }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BASE_URL="${{ github.event.client_payload.base_url || 'https://endpoints-fast-api.onrender.com' }}"
            TEST_PLAN="${{ github.event.client_payload.test_plan || 'test-plans/jmeter/tp-carga-controlada.jmx' }}"
          else
            BASE_URL="https://endpoints-fast-api.onrender.com"
            TEST_PLAN="test-plans/jmeter/tp-carga-controlada.jmx"
          fi
          
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          echo "test_plan=$TEST_PLAN" >> $GITHUB_OUTPUT
          
          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV
          echo "TEST_PLAN=$TEST_PLAN" >> $GITHUB_ENV
      
      # ============================================================
      # 4. VALIDAR URL (FIX: detecta URLs malformadas antes de continuar)
      - name: üîé Validar formato de URL
        run: |
          URL="${{ steps.config.outputs.base_url }}"
          echo "URL recibida: $URL"
          
          # Detectar caracteres de markdown u otros artefactos comunes
          if [[ "$URL" == *"__"* ]] || [[ "$URL" == *"**"* ]] || [[ "$URL" == *" "* ]]; then
            echo "‚ùå ERROR: La URL contiene caracteres inv√°lidos: '$URL'"
            echo "Aseg√∫rate de ingresar solo la URL sin formato markdown ni espacios."
            exit 1
          fi
          
          # Validar que empiece con http:// o https://
          if [[ "$URL" != http://* ]] && [[ "$URL" != https://* ]]; then
            echo "‚ùå ERROR: La URL no tiene un esquema v√°lido (http/https): '$URL'"
            exit 1
          fi
          
          echo "‚úÖ URL v√°lida: $URL"

      # ============================================================
      # 5. SHOW CONFIG
      - name: üìã Mostrar configuraci√≥n
        run: |
          echo "================================================"
          echo "Base URL:    ${{ steps.config.outputs.base_url }}"
          echo "Test Plan:   ${{ steps.config.outputs.test_plan }}"
          echo "JMeter:      ${JMETER_VERSION}"
          echo "================================================"
      
      # ============================================================
      # 6. CACHE DOCKER
      - name: üíæ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      # ============================================================
      # 7. BUILD IMAGE
      - name: üî® Build imagen Docker
        run: |
          echo "üî® Construyendo imagen Docker..."
          docker build \
            --build-arg JMETER_VERSION=${JMETER_VERSION} \
            -t jmeter-runner:latest \
            -f Dockerfile \
            .
          echo "‚úÖ Imagen construida exitosamente"

      # ============================================================
      # 8. VALIDAR API
      - name: üîç Validar disponibilidad API
        if: ${{ !contains(steps.config.outputs.base_url, 'localhost') }}
        run: |
          echo "üîç Verificando disponibilidad de la API..."
          
          MAX_RETRIES=12
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -sf "${{ steps.config.outputs.base_url }}/api/v1/health" > /dev/null 2>&1; then
              echo "‚úÖ API disponible"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Intento $RETRY_COUNT/$MAX_RETRIES - esperando..."
            sleep 10
          done
          
          echo "‚ö†Ô∏è API no respondi√≥ al health check"
          echo "Continuando de todas formas..."
      
      # ============================================================
      # 9. CREATE DIRS
      - name: üìÇ Crear directorios
        run: |
          mkdir -p results docs
          chmod -R 777 results docs
      
      # ============================================================
      # 10. RUN TESTS
      - name: üöÄ Ejecutar pruebas
        run: |
          echo "üê≥ Ejecutando contenedor Docker..."
          docker run --rm \
            -v $(pwd)/results:/tests/results \
            -v $(pwd)/docs:/tests/docs \
            -v $(pwd)/test-plans:/tests/test-plans:ro \
            -v $(pwd)/data:/tests/data:ro \
            -e BASE_URL="${{ steps.config.outputs.base_url }}" \
            -e TEST_PLAN="${{ steps.config.outputs.test_plan }}" \
            jmeter-runner:latest \
            python3 scripts/execute-tests.py \
              --base-url="${{ steps.config.outputs.base_url }}" \
              --test-plan="${{ steps.config.outputs.test_plan }}"
          echo "‚úÖ Contenedor finalizado"

      # ============================================================
      # 11. VERIFY RESULTS
      - name: üîç Verificar resultados
        run: |
          echo "üìÇ Verificando estructura de archivos generados..."
          ls -lah results || exit 1
          ls -lah docs || exit 1
      
      # ============================================================
      # 12. UPLOAD ARTIFACTS
      - name: üìä Publicar reporte
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ github.run_number }}
          path: |
            docs/
            results/run_*/
      
      # ============================================================
      # 13. COMMIT REPORT
      - name: üíæ Commit report to repository
        if: success()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add docs/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update JMeter report - run ${{ github.run_number }}"
            git push
          fi
      
      # ============================================================
      # 14. CLEANUP
      - name: üßπ Limpiar Docker
        if: always()
        run: docker system prune -f